services:
  backend:
    build:
      context: ./backend
      target: dev
    working_dir: /app
    command: cargo watch -x run
    env_file:
      - path: .env.local
        required: false
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-t_rader}:${POSTGRES_PASSWORD:-t_rader}@db:5432/${POSTGRES_DB:-t_rader_development}
      CARGO_HOME: /usr/local/cargo
    ports:
      - '127.0.0.1:${BACKEND_PORT:-3000}:3000'
    volumes:
      - ./backend:/app
      - cargo_home:/usr/local/cargo
      - backend_target:/app/target
    networks:
      - t-rader-net

  frontend:
    image: oven/bun:1.3.9
    working_dir: /app
    command: sh -c "bun install && bun run --bun vite --host"
    environment:
      VITE_API_URL: http://backend:3000
    ports:
      - '127.0.0.1:${FRONTEND_PORT:-5173}:5173'
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    depends_on:
      - backend
    networks:
      - t-rader-net

volumes:
  cargo_home:
  backend_target:
  frontend_node_modules:

networks:
  t-rader-net:
    external: true
