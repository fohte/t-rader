name: Docker

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - component: backend
            context: ./backend
          - component: frontend
            context: ./frontend

    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        id: setup-buildx

      - name: Log in to ghcr.io
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        if: github.event_name == 'push'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/${{ matrix.component }}
          tags: |
            type=sha
            type=raw,value=latest

      # backend: RUN --mount=type=cache のキャッシュを GHA キャッシュに永続化する。
      # GHA 環境では BuildKit cache mount のデータが type=gha バックエンドに保存されないため、
      # buildkit-cache-dance を使って actions/cache 経由で永続化する。
      # ref: https://github.com/moby/buildkit/issues/3011
      - name: Restore Cargo cache
        if: matrix.component == 'backend'
        uses: actions/cache@v5
        id: cargo-cache
        with:
          path: cargo-cache
          key: cargo-cache-${{ hashFiles('backend/Cargo.lock') }}
          restore-keys: |
            cargo-cache-

      - name: Inject Cargo cache into Docker
        if: matrix.component == 'backend'
        uses: reproducible-containers/buildkit-cache-dance@v3
        with:
          builder: ${{ steps.setup-buildx.outputs.name }}
          cache-dir: cargo-cache
          dockerfile: backend/Dockerfile
          skip-extraction: ${{ steps.cargo-cache.outputs.cache-hit }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # frontend: レイヤーキャッシュを GHA cache backend で永続化する。
          # backend は cache mount + buildkit-cache-dance で永続化するため不要。
          # cache-from/cache-to と buildkit-cache-dance を併用すると、Post ステップの
          # extraction 用ビルドで BuildKit が cache mount をリセットしてしまう。
          # ref: https://github.com/reproducible-containers/buildkit-cache-dance/issues/33
          cache-from: ${{ matrix.component == 'frontend' && format('type=gha,scope={0}', matrix.component) || '' }}
          cache-to: ${{ matrix.component == 'frontend' && format('type=gha,mode=max,scope={0}', matrix.component) || '' }}
          # ghcr.io の private パッケージに push する際、provenance attestation の
          # manifest push 時に permission_denied: read_package エラーが発生する既知の問題
          # (ghcr.io 側の問題で、2026-02 時点で未修正) があるため無効化。
          # 代替手段として actions/attest-build-provenance を別ステップで使う方法があるが、
          # GitHub Enterprise Cloud プランが必要なため Free/Pro の private リポジトリでは利用不可。
          # ref: https://github.com/docker/build-push-action/issues/981
          # ref: https://github.com/docker/build-push-action/issues/900
          provenance: false

  # イメージ push 後に Keel webhook で Kubernetes のデプロイを更新する
  notify-keel:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    steps:
      - name: Connect to Tailscale
        uses: tailscale/github-action@v4.1.1
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_CI_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_CI_OAUTH_CLIENT_SECRET }}
          tags: tag:ci

      - name: Notify Keel
        run: |
          curl --fail -X POST \
            -H 'Content-Type: application/json' \
            -d '{"name": "ghcr.io/fohte/t-rader/backend", "tag": "latest"}' \
            "$KEEL_WEBHOOK_URL"
          curl --fail -X POST \
            -H 'Content-Type: application/json' \
            -d '{"name": "ghcr.io/fohte/t-rader/frontend", "tag": "latest"}' \
            "$KEEL_WEBHOOK_URL"
        env:
          KEEL_WEBHOOK_URL: ${{ secrets.KEEL_WEBHOOK_URL }}
